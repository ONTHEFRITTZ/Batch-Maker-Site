"use strict";(()=>{var e={};e.id=72,e.ids=[72],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1309:e=>{e.exports=import("@supabase/supabase-js")},6090:e=>{e.exports=import("stripe")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8625:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>p,default:()=>u,routeModule:()=>d});var o=r(1802),i=r(7153),a=r(6249),n=r(3972),c=e([n]);n=(c.then?(await c)():c)[0];let u=(0,a.l)(n,"default"),p=(0,a.l)(n,"config"),d=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/webhook/stripe",pathname:"/api/webhook/stripe",bundlePath:"",filename:""},userland:n});s()}catch(e){s(e)}})},3972:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>d,default:()=>c});var o=r(6090),i=r(1309),a=e([o,i]);[o,i]=a.then?(await a)():a;let u=new o.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2026-01-28.clover"}),p=(0,i.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY),d={api:{bodyParser:!1}};async function n(e){let t=[];for await(let r of e)t.push("string"==typeof r?Buffer.from(r):r);return Buffer.concat(t)}async function c(e,t){let r;if("POST"!==e.method)return t.status(405).end();let s=await n(e),o=e.headers["stripe-signature"];try{r=u.webhooks.constructEvent(s,o,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed:",e.message),t.status(400).send(`Webhook Error: ${e.message}`)}console.log("✅ Webhook received:",r.type);try{switch(r.type){case"customer.subscription.created":case"customer.subscription.updated":{let e=r.data.object;await p.from("profiles").update({stripe_customer_id:e.customer,stripe_subscription_id:e.id,subscription_status:e.status,subscription_price_id:e.items.data[0].price.id,subscription_expires_at:new Date(1e3*e.current_period_end).toISOString()}).eq("stripe_customer_id",e.customer);break}case"customer.subscription.deleted":let e=r.data.object;await p.from("profiles").update({subscription_status:"cancelled"}).eq("stripe_subscription_id",e.id),console.log("✅ Subscription cancelled:",e.id);break;case"invoice.payment_failed":let s=r.data.object;console.log("⚠️ Payment failed for customer:",s.customer)}t.status(200).json({received:!0})}catch(e){console.error("Webhook handler error:",e),t.status(500).json({error:e.message})}}s()}catch(e){s(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=8625);module.exports=r})();